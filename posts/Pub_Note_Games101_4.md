---
title: Games101 4.Transformation Cont.
---

补充上节课的内容：
![Alt text](image.png)

- 如果我们逆时针旋转-theta 角度，会发现得到的矩阵刚好是旋转 theta 角度的转置矩阵。
- 即旋转矩阵的逆等于旋转矩阵的转置。
- 在数学上，我们把这样的矩阵叫做正交矩阵。

## 3D Transformations

用齐次坐标表示三维空间中的点或向量：
![Alt text](image-1.png)
![Alt text](image-2.png)
有一个问题是，在这样的矩阵表示下，我们是先应用线性变换还是先应用平移？
如果我们把变换展开就很清楚了：
$\begin{bmatrix} x' \\ y' \\ z' \end{bmatrix} = \begin{bmatrix} s_x & 0 & 0 \\ 0 & s_y & 0 \\ 0 & 0 & s_z\end{bmatrix} \begin{bmatrix} x \\ y \\ z \end{bmatrix} + \begin{bmatrix} t_x \\ t_y \\ t_z \end{bmatrix}$
是先应用线性变换，再加上平移量。

![Alt text](image-3.png)

绕任意轴的旋转矩阵很难写，但是我们可以先从简单的开始，绕 x, y, z 轴的旋转矩阵：
![Alt text](image-4.png)

- 绕哪个轴旋转，哪个轴对应的坐标就应该是不变的
- 除去这个特殊的行和列，剩下部分其实就是一个二维的旋转矩阵

为什么$R_y$的矩阵和$R_x$和$R_z$的矩阵不一样？

- 如果你尝试像之前二维旋转矩阵推导的图应用在这些平面上，xoz 平面、yoz 平面、xoy 平面，你会发现只有 xoz 平面是按顺时针旋转的，其他两个是逆时针旋转的。
- 或者从叉乘的角度来看，$x \times y = z$，$y \times z = x$，$z \times x = y$，其中$ z \times x = y$，这个顺序跟坐标的顺序是反的。

![Alt text](image-5.png)

- 把复杂的旋转分解成绕 x, y, z 轴的旋转
- 绕 x、y、z 轴的角度分别叫做 pitch($\alpha$)、yaw($\beta$)、roll($\gamma$)角，这三个角叫做欧拉角。

### Rodrigues' Rotation Formula

![Alt text](image-6.png)

- 罗德里格斯公式根据旋转轴和旋转角度来计算旋转矩阵。
- 其中旋转轴通过一个向量来定义，那么存在一个问题，一个向量只能定义一个方向，但是旋转轴的起点在哪里呢？
  实际上，我们默认旋转轴是过原点的，如果旋转轴不过原点，我们可以先把旋转轴平移到原点，然后再旋转，最后再平移回去。

另外一个值得注意的点是最右边的矩阵跟叉乘里边的 dual matrix 是一样的。

推导：
![Alt text](image-7.png)
![Alt text](image-8.png)
![Alt text](image-9.png)

这门课不会谈论四元数，在这里简单的说一下：图形学中四元数主要是用来解决旋转插值的问题。

## Viewing Transformation

### View/Camera Transformation

![Alt text](image-10.png)

现实中怎么拍一张照片：

- 找一个好的地方，把所有人都集合在那里摆好 pose（模型变换）
- 找一个好的角度，或者说找一个好的位置，把这个相机放好，往某一个角度去看（视图变换）
- 拍照（投影变换）

图形学中也是这样的，拆分为三个变换模型：mvp（model view projection）

首先来看一下 view transformation：
怎么定义 view 的角度：
![Alt text](image-11.png)

- 一方面是向哪个方向看，即 look at
- 另一方面确定有没有一个自身的旋转，我们用 up direction 来定义

就像在摄影棚一样，把相机固定在一个位置和角度，在图形学中我们总是希望把相机放在原点，往负 z 方向看，y 轴向上。
![Alt text](image-12.png)
具体怎么做呢：
![Alt text](image-13.png)
y 跟 z 对齐了，x 自然而然也就对上了

表示为矩阵形式：
![Alt text](image-14.png)

- 把标准轴转到特定的轴简单，但反回来就很难，所以我们先求逆变换
- 旋转矩阵是正交矩阵，所以逆变换就是转置

关于模型变换和视图变换：

- 视图变换操作的是相机，然后其他物体跟着变换。
- 因为它们两都是对物体的变换，所以经常一起称为模型视图变换。

## Projection Transformation

有两种不同的投影方式：

- 正交投影（orthographic）
- 透视投影（perspective）

![Alt text](image-15.png)

- 左边正交投影的平行线还是平行的
- 但右边透视投影的就不是了，延长后会相交在一个点上
- 正交投影更多用于工程制图

![Alt text](image-16.png)

### Orthographic Projection

用一种简单的方式来描述：
![Alt text](image-17.png)

- 正交投影相当于是物体不管远近都被挤到一个平面上
- 直接去掉 z 坐标
- 然后不管 x 和 y 的范围有多大，都被挤到-1 到 1 的矩形上（一个约定俗成的做法，方便后面计算）

图形学中更正式的说法：
![Alt text](image-18.png)

把 xyz3 个轴的范围都映射到-1 到 1 的立方体上，这个立方体叫做 canonical cube。

![Alt text](image-19.png)

- 正式的作法，我们先做平移，然后再缩放

把这个变换写成矩阵形式：
![Alt text](image-20.png)

- 首先是从将中点平移到原点
- 然后缩放到-1 到 1 的范围，就是 2

![Alt text](image-21.png)

- 因为我们是往负 z 方向看，所以远的物体 z 值更小，这是右手坐标系导致的一个问题
- 所以像 OpenGL 这样的 API 会默认用左手系，因为左手系在这一点上会相对方便一些。但是会导致别的问题，比如 x 乘 y 不等于 z

### Perspective Projection

![Alt text](image-22.png)
![Alt text](image-23.png)

- 欧式几何里平行线永不相交，但在透视投影里会相交，这是为什么？难道欧拉错了？
- 欧式几何指的是在同一个平面里，但是在透视投影里涉及到不同的平面和角度

在具体说透视投影之前，我们需要回顾齐次坐标，这个对于透视投影很重要：
![Alt text](image-24.png)


怎么做透视投影呢：
![Alt text](image-25.png)
- 需要把视锥体（frustum）“挤压”成一个长方体，然后再做正交投影。
- 首先对应的这些经过挤压之后得保持对应，近平面的点都不变
- 然后远平面的z值不变
- 远平面的中心挤压后还是中心

挤压怎么做：
![Alt text](image-26.png)

- 可以根据侧面图的相似三角形得到高度跟深度的一个比例的关系
- 对于x也是同样的道理

那么现在我们给定任意一个x y z，我们都能得到它的新的坐标x' y'，只是z还不知道：
![Alt text](image-27.png)
![Alt text](image-28.png)
目标是算出左边的矩阵是什么。

我们可以利用两个观察到的现象：
- 远平面上的点经过变换之后z不变
- 中间的点经过变换之后z不变

它们的 z 不变

而这也就够了

这就是我们现在需要的这么

### 01:08:40,14

![01-08-40](tmp/01-08-40.jpg)

这么两两个这个呃小的观察啊

虽然很小

但很有用

然后呢呃大家看这两个观察是什么呢

第一任何一个点

也就是说这个矩阵它对于任何的 x y n1

这样的点

为什么 x y n 一呢

对于任何的 x y n1

然后运算完了之后

一定还得到的是同一个点 xyn 没有问题

然后呢圆的平面两个平面

虽然它的 x y 会往里挤啊

但是它的 z 没有变化对吧

这也是咱们刚才规定的远处的这

个平面上

它的 z 经过变换之后也不会发生变化

那咱们把这两点给利用起来

那么怎么把它利用起来呢

### 01:09:28,16

![01-09-28](tmp/01-09-28.jpg)

啊大家可以看到这里

我我说如果说这个左边

这是一个这个通用的这个写法啊

那我把 z 认为是 n

也就是说对于这个 xyn 1

他永远会被映射回他自己

xy n 一就乘上这个矩阵之后

一定等于他自己等于他自己这事儿

可可是这没 5 万哈

就是说我只说他会表示相同的这个这个啊

相同的三维空间中的点

可是没说在齐次坐标下的表示一定得一样

对吧

那他自己 xy n1

那也可以写成什么呢

也可以写成 n x n y n 平方和 n 没问题吧

就是我把四个数都乘以 n

那我表示的点当然还是他自己 x y n

没有问题

所以把这一个向量是可以通过这个矩阵乘

映射成右边这么一个向量的

而这四个这这个向量

它们它们两个向量表示的都是同一个点

x y n

所以没问题

那么咱们现在再看这个信息

可以告诉我们什么呢

这个信息可以告诉我们哦

这个 unknown 这个数

现在它现在我们知道啊

对于一个这个呃给定的这个呃深度 n

那么呃我们

可以知道呃得出来的结果

左边就是这个向量 xy n1

左边乘以 m 之后

它的这个第三个数是 n 平方

那么我们可以把它写出来对吧

矩阵的第三行呃

四个数

这四个数乘以这么一个矩阵

得到的是这第三个数 n 平方

那么呃我们想象一下啊

这个 n 平方显然和 x 和 y 都没有关系

所以如果一个向量点乘这么一个向量

可以得到 n 平方的话

那么我前两个数必然得是零

它不能是任何的

比如说零点多少 x 加多少 y

它跟 xy 一定都没有关系

零零后面两个数我不知道

有同学说了

那后面两

个数会不会是 n 和一啊

因为 n 乘 n 得的平方一啊

不 n 和零哈

就是说 0x1 得得零

n 乘 n 的 n 平方加起来是 n 平方

可是这个事情说不准

为什么呢

你可以 a 等于零

a 等于零

零乘 n 等于零

然后 b 等于 n 平方

n 平方乘以一也可以得到 n 平方

所以说呃通过这这个一个性质啊

还不够还不够啊

就是说我们的第三行大家还记得吗

刚才这个矩阵缺第三行

通过这个方法

我们已经可以把它的前两个数都填成零了

那么现在就只有说这个这个 a 和 b

这两个数我不知道

但是没关系

我

知道这么一个式子了

已经就是零零 ab 乘以 x y n 一等于 n 平方

那咱们现在只用了一个性质

然后呃任意一个点

我们都可以通过他们这个在变换之后

不变这么一个属性

然后来这个推出这个两个数

那么别忘了咱们还有另外的两个数对吧

另外不是另外两个数

另外一个观察到的现象

### 01:12:27,27

![01-12-27](tmp/01-12-27.jpg)

仍然是这个满足这么一个性质的什么呢

并且咱们就取一个点

什么点呢

那

咱们先回到前面的这几页上面去啊

这个大家还记得吗

### 01:12:43,49

![01-12-43](tmp/01-12-43.jpg)

我们刚才说啊

经过挤压之后

但是有一个点很特殊

在这个中间的这个点上

它的 x y 都是零

经过挤压之后

它不仅他还在这个 x y z 上

x y f 上

它位置也没有发生变化

它仍然是 00f 对吧

所以 00f 这个点经过这个变换之后

挤压之后

它仍然是这个面的中心点

所以咱们再回到这一页上来看

00f 这么一个点

经过变换仍然等于 00f

并且呢咱们还回到

刚才这个式子上来看

大家看到 x y y z

一会被映射到这个最后一个数

得是 z 来看啊

这个这个数等于是 z

所以所以说咱们同样道理

00f 一映射回 00f 一之后

但不够

我们希望最后一个数是 f

那么就把所有东西都乘以 f

00f1

跟 00f 平方 f 表示的完全是同一个点

00f 没问题

所以呢咱们现在就看这个零零 ab 这个向量

也就是原本的这个啊

矩阵的第三行乘以这么一列

得到的结果应该是这么一个结果

那咱们可以把它展开

咱们也可以

把它给这个展开

那么我们就得到了两个式子啊

我们得到了一个式子跟 ab 有关

我们得到了另外一个式子

这个式子呢也是也也是跟 ab 有关

那么把这两个式子放在一块儿

我发现啊

近和远我们都知道那两个式子

两个变量我们当然可以解除

a 跟 b 都是什么

好到此为止

咱们终于把这个矩阵给填完了

哪个矩阵

这个 perspective to orthographic

也就是说

我们把这个这个这个

这个从透视投影的这么一个 frost

我先把它给挤成了一个这个长方体好

那么

我们把这部分完成了

完成的时候怎么办呀

还要继续做正交投影对吗

这也就是说我们先把这个矩阵呃

这个做完再做另外一个正交投影

结束了之后

这两个再合在一块儿

这就是我们要的透视投影

我们最终就可以把一个任何一个远处的

是什么点被投影到一个这个这个上面嗯

好

到此为止

咱们的这个这个呃透视投影

咱们就已经这个说完了

我这个给大家留下一个问题

而这个问题绝对不容易

那咱们这个

### 01:15:10,97

![01-15-10](tmp/01-15-10.jpg)

### 01:13:10,61

![01-13-10](tmp/01-13-10.jpg)

00f 这么一个点

经过变换仍然等于 00f

并且呢咱们还回到

刚才这个式子上来看

大家看到 x y y z

一会被映射到这个最后一个数

得是 z 来看啊

这个这个数等于是 z

所以所以说咱们同样道理

### 01:13:25,26

![01-13-25](tmp/01-13-25.jpg)

00f 一映射回 00f 一之后

但不够

我们希望最后一个数是 f

那么就把所有东西都乘以 f

00f1

跟 00f 平方 f 表示的完全是同一个点

00f 没问题

所以呢咱们现在就看这个零零 ab 这个向量

也就是原本的这个啊

矩阵的第三行乘以这么一列

得到的结果应该是这么一个结果

那咱们可以把它展开

咱们也可以

把它给这个展开

那么我们就得到了两个式子啊

我们得到了一个式子跟 ab 有关

我们得到了另外一个式子

这个式子呢也是也也是跟 ab 有关

那么把这两个式子放在一块儿

### 01:14:07,4

![01-14-07](tmp/01-14-07.jpg)

我发现啊

近和远我们都知道那两个式子

两个变量我们当然可以解除

a 跟 b 都是什么

好到此为止

咱们终于把这个矩阵给填完了

哪个矩阵

这个 perspective to orthographic

也就是说

我们把这个这个这个

这个从透视投影的这么一个 frost

我先把它给挤成了一个这个长方体好

那么

我们把这部分完成了

完成的时候怎么办呀

还要继续做正交投影对吗

这也就是说我们先把这个矩阵呃

这个做完再做另外一个正交投影

结束了之后

这两个再合在一块儿

这就是我们要的透视投影

我们最终就可以把一个任何一个远处的

是什么点被投影到一个这个这个上面嗯

好

到此为止

咱们的这个这个呃透视投影

咱们就已经这个说完了

我这个给大家留下一个问题

而这个问题绝对不容易

那咱们这个

嗯还是这么来看啊

### 01:15:12,67

![01-15-12](tmp/01-15-12.jpg)

就是说呃我们在这里呢

这个这个呃做了这么一个挤压的

这么一个过程中啊

我们一直在考虑说啊

对于普通的点 x y z 啊

它的 x 跟 y 要怎么变

它的 z 不变没错

那么我现在的问题就是说

对于中间的任何一个 z

比如说在 n 加 f 除以二

这个中间这个位置上啊

对于中间的任何一个点啊

然后呢对对于对于中间任何一点 x y

然后某一个 z 然后经过变换之后

然后它的 z 会变小还是会变大

还是会不变 o 所以是这么一个问题啊

它的 z 经过变换

经过挤压之后都没有发生变化

但是我的问题是对于中间的某一个点

然后他这个呃

经过这个挤压的这个变换之后

它的 z 到底会变小还是变大还是会不变呢

然后另外一点是这样

就是说涉及到小跟大这么个关系了

因为我们涉及到这个这个呃

往负 z 方向看啊

所以这个 n 其实其实这个呃小于啊

呃其实大于 f 哈对吧

所以这样比较容易混乱

那我问一个更直观的问题

就直接这么直接这么看

### 01:16:28,58

![01-16-28](tmp/01-16-28.jpg)

### 01:16:29,68

![01-16-29](tmp/01-16-29.jpg)

就是说当你的任何一个点 x y

然后 z 等

于二分之 n 加 f 就是在这个正中间的时候

然后经过这个挤压之后

还是会被推向圆的平面

大家回去可以思考这么一个问题

好吧

呃当然这个其实这么一说呢

就已经帮大家排除了这个点不动的可能性

哈哈哈哈啊对吧

我说 z 方向 z 方向不动的可能性

然后这个听上去有点不可思议对吧

我做这个挤压

为什么还会让这个中间的点

他们的 z 向前或者向后移动对吧

所以这个呃是大家之后可以思考的问题

大家可以把这个 z 显示的写出来

然后大家就可

以看到这个这到底会发生什么变化

是会变得更像 f 还是更像呃好吧

那咱们这个今天咱们就说到这

感谢大家这个持续的支持啊

咱们推了这么困难的一个

### 01:17:18,46

![01-17-18](tmp/01-17-18.jpg)

这个这个这个呃矩阵啊

当然如果大家能够理解这个那就太好了

没有任何问题

就是说这应该就是这么一个呃

我们前几节课

或者说整个一节课涉及到最复杂的推导了

很可能就是这个好吧

如果大家觉得有什么难度

没什么问题好吧

那么呃再重申一下作业零呢

咱们今天会这个这个放出来

然后我们的助教同学还在这个努

力的这个工作中好吗

然然后这个呃其他还有什么呢

我这样

我之后关注一下这个大家论坛上面

问题或者干什么

如果大家这节课有各种各样的疑问

欢迎提出

然后我和助教们都会这个

想办法来给大家讲解

那咱们今天就说到这儿啊

大家这个抓紧去吃饭啊

嘿嘿嘿嘿嘿啊

ok 那咱们下期再见啊

### 01:18:06,94

![01-18-06](tmp/01-18-06.jpg)

拜拜

